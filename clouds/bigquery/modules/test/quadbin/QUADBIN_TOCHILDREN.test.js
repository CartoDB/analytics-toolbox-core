const { runQuery } = require('../../../common/test-utils');

test('QUADBIN_TOCHILDREN should work', async () => {
    const query = 'SELECT TO_JSON_STRING(`@@BQ_DATASET@@.QUADBIN_TOCHILDREN`(5209574053332910079, 5)) AS output';
    const rows = await runQuery(query);
    expect(rows.length).toEqual(1);
    const out = JSON.stringify((JSON.parse(rows[0].output)).sort())
    expect(out).toEqual('["5214064458820747263","5214068856867258367","5214073254913769471","5214077652960280575"]');
});

test('QUADBIN_TOCHILDREN should work', async () => {
    const query = 'SELECT TO_JSON_STRING(`@@BQ_DATASET@@.QUADBIN_TOCHILDREN`(5209574053332910079, 7)) AS output';
    const rows = await runQuery(query);
    expect(rows.length).toEqual(1);
    const out = JSON.stringify((JSON.parse(rows[0].output)).sort())
    expect(out).toEqual('["5223067534906884095","5223067809784791039","5223068084662697983","5223068359540604927","5223068634418511871","5223068909296418815","5223069184174325759","5223069459052232703","5223069733930139647","5223070008808046591","5223070283685953535","5223070558563860479","5223070833441767423","5223071108319674367","5223071383197581311","5223071658075488255","5223071932953395199","5223072207831302143","5223072482709209087","5223072757587116031","5223073032465022975","5223073307342929919","5223073582220836863","5223073857098743807","5223074131976650751","5223074406854557695","5223074681732464639","5223074956610371583","5223075231488278527","5223075506366185471","5223075781244092415","5223076056121999359","5223076330999906303","5223076605877813247","5223076880755720191","5223077155633627135","5223077430511534079","5223077705389441023","5223077980267347967","5223078255145254911","5223078530023161855","5223078804901068799","5223079079778975743","5223079354656882687","5223079629534789631","5223079904412696575","5223080179290603519","5223080454168510463","5223080729046417407","5223081003924324351","5223081278802231295","5223081553680138239","5223081828558045183","5223082103435952127","5223082378313859071","5223082653191766015","5223082928069672959","5223083202947579903","5223083477825486847","5223083752703393791","5223084027581300735","5223084302459207679","5223084577337114623","5223084852215021567"]');
});

test('QUADBIN_TOCHILDREN should work', async () => {
    const query = 'SELECT TO_JSON_STRING(`@@BQ_DATASET@@.QUADBIN_TOCHILDREN`(5209574053332910079, 9)) AS output';
    const rows = await runQuery(query);
    expect(rows.length).toEqual(1);
    const out = JSON.stringify((JSON.parse(rows[0].output)).sort())
    expect(out).toEqual('["5232074476463587327","5232074493643456511","5232074510823325695","5232074528003194879","5232074545183064063","5232074562362933247","5232074579542802431","5232074596722671615","5232074613902540799","5232074631082409983","5232074648262279167","5232074665442148351","5232074682622017535","5232074699801886719","5232074716981755903","5232074734161625087","5232074751341494271","5232074768521363455","5232074785701232639","5232074802881101823","5232074820060971007","5232074837240840191","5232074854420709375","5232074871600578559","5232074888780447743","5232074905960316927","5232074923140186111","5232074940320055295","5232074957499924479","5232074974679793663","5232074991859662847","5232075009039532031","5232075026219401215","5232075043399270399","5232075060579139583","5232075077759008767","5232075094938877951","5232075112118747135","5232075129298616319","5232075146478485503","5232075163658354687","5232075180838223871","5232075198018093055","5232075215197962239","5232075232377831423","5232075249557700607","5232075266737569791","5232075283917438975","5232075301097308159","5232075318277177343","5232075335457046527","5232075352636915711","5232075369816784895","5232075386996654079","5232075404176523263","5232075421356392447","5232075438536261631","5232075455716130815","5232075472895999999","5232075490075869183","5232075507255738367","5232075524435607551","5232075541615476735","5232075558795345919","5232075575975215103","5232075593155084287","5232075610334953471","5232075627514822655","5232075644694691839","5232075661874561023","5232075679054430207","5232075696234299391","5232075713414168575","5232075730594037759","5232075747773906943","5232075764953776127","5232075782133645311","5232075799313514495","5232075816493383679","5232075833673252863","5232075850853122047","5232075868032991231","5232075885212860415","5232075902392729599","5232075919572598783","5232075936752467967","5232075953932337151","5232075971112206335","5232075988292075519","5232076005471944703","5232076022651813887","5232076039831683071","5232076057011552255","5232076074191421439","5232076091371290623","5232076108551159807","5232076125731028991","5232076142910898175","5232076160090767359","5232076177270636543","5232076194450505727","5232076211630374911","5232076228810244095","5232076245990113279","5232076263169982463","5232076280349851647","5232076297529720831","5232076314709590015","5232076331889459199","5232076349069328383","5232076366249197567","5232076383429066751","5232076400608935935","5232076417788805119","5232076434968674303","5232076452148543487","5232076469328412671","5232076486508281855","5232076503688151039","5232076520868020223","5232076538047889407","5232076555227758591","5232076572407627775","5232076589587496959","5232076606767366143","5232076623947235327","5232076641127104511","5232076658306973695","5232076675486842879","5232076692666712063","5232076709846581247","5232076727026450431","5232076744206319615","5232076761386188799","5232076778566057983","5232076795745927167","5232076812925796351","5232076830105665535","5232076847285534719","5232076864465403903","5232076881645273087","5232076898825142271","5232076916005011455","5232076933184880639","5232076950364749823","5232076967544619007","5232076984724488191","5232077001904357375","5232077019084226559","5232077036264095743","5232077053443964927","5232077070623834111","5232077087803703295","5232077104983572479","5232077122163441663","5232077139343310847","5232077156523180031","5232077173703049215","5232077190882918399","5232077208062787583","5232077225242656767","5232077242422525951","5232077259602395135","5232077276782264319","5232077293962133503","5232077311142002687","5232077328321871871","5232077345501741055","5232077362681610239","5232077379861479423","5232077397041348607","5232077414221217791","5232077431401086975","5232077448580956159","5232077465760825343","5232077482940694527","5232077500120563711","5232077517300432895","5232077534480302079","5232077551660171263","5232077568840040447","5232077586019909631","5232077603199778815","5232077620379647999","5232077637559517183","5232077654739386367","5232077671919255551","5232077689099124735","5232077706278993919","5232077723458863103","5232077740638732287","5232077757818601471","5232077774998470655","5232077792178339839","5232077809358209023","5232077826538078207","5232077843717947391","5232077860897816575","5232077878077685759","5232077895257554943","5232077912437424127","5232077929617293311","5232077946797162495","5232077963977031679","5232077981156900863","5232077998336770047","5232078015516639231","5232078032696508415","5232078049876377599","5232078067056246783","5232078084236115967","5232078101415985151","5232078118595854335","5232078135775723519","5232078152955592703","5232078170135461887","5232078187315331071","5232078204495200255","5232078221675069439","5232078238854938623","5232078256034807807","5232078273214676991","5232078290394546175","5232078307574415359","5232078324754284543","5232078341934153727","5232078359114022911","5232078376293892095","5232078393473761279","5232078410653630463","5232078427833499647","5232078445013368831","5232078462193238015","5232078479373107199","5232078496552976383","5232078513732845567","5232078530912714751","5232078548092583935","5232078565272453119","5232078582452322303","5232078599632191487","5232078616812060671","5232078633991929855","5232078651171799039","5232078668351668223","5232078685531537407","5232078702711406591","5232078719891275775","5232078737071144959","5232078754251014143","5232078771430883327","5232078788610752511","5232078805790621695","5232078822970490879","5232078840150360063","5232078857330229247","5232078874510098431","5232078891689967615","5232078908869836799","5232078926049705983","5232078943229575167","5232078960409444351","5232078977589313535","5232078994769182719","5232079011949051903","5232079029128921087","5232079046308790271","5232079063488659455","5232079080668528639","5232079097848397823","5232079115028267007","5232079132208136191","5232079149388005375","5232079166567874559","5232079183747743743","5232079200927612927","5232079218107482111","5232079235287351295","5232079252467220479","5232079269647089663","5232079286826958847","5232079304006828031","5232079321186697215","5232079338366566399","5232079355546435583","5232079372726304767","5232079389906173951","5232079407086043135","5232079424265912319","5232079441445781503","5232079458625650687","5232079475805519871","5232079492985389055","5232079510165258239","5232079527345127423","5232079544524996607","5232079561704865791","5232079578884734975","5232079596064604159","5232079613244473343","5232079630424342527","5232079647604211711","5232079664784080895","5232079681963950079","5232079699143819263","5232079716323688447","5232079733503557631","5232079750683426815","5232079767863295999","5232079785043165183","5232079802223034367","5232079819402903551","5232079836582772735","5232079853762641919","5232079870942511103","5232079888122380287","5232079905302249471","5232079922482118655","5232079939661987839","5232079956841857023","5232079974021726207","5232079991201595391","5232080008381464575","5232080025561333759","5232080042741202943","5232080059921072127","5232080077100941311","5232080094280810495","5232080111460679679","5232080128640548863","5232080145820418047","5232080163000287231","5232080180180156415","5232080197360025599","5232080214539894783","5232080231719763967","5232080248899633151","5232080266079502335","5232080283259371519","5232080300439240703","5232080317619109887","5232080334798979071","5232080351978848255","5232080369158717439","5232080386338586623","5232080403518455807","5232080420698324991","5232080437878194175","5232080455058063359","5232080472237932543","5232080489417801727","5232080506597670911","5232080523777540095","5232080540957409279","5232080558137278463","5232080575317147647","5232080592497016831","5232080609676886015","5232080626856755199","5232080644036624383","5232080661216493567","5232080678396362751","5232080695576231935","5232080712756101119","5232080729935970303","5232080747115839487","5232080764295708671","5232080781475577855","5232080798655447039","5232080815835316223","5232080833015185407","5232080850195054591","5232080867374923775","5232080884554792959","5232080901734662143","5232080918914531327","5232080936094400511","5232080953274269695","5232080970454138879","5232080987634008063","5232081004813877247","5232081021993746431","5232081039173615615","5232081056353484799","5232081073533353983","5232081090713223167","5232081107893092351","5232081125072961535","5232081142252830719","5232081159432699903","5232081176612569087","5232081193792438271","5232081210972307455","5232081228152176639","5232081245332045823","5232081262511915007","5232081279691784191","5232081296871653375","5232081314051522559","5232081331231391743","5232081348411260927","5232081365591130111","5232081382770999295","5232081399950868479","5232081417130737663","5232081434310606847","5232081451490476031","5232081468670345215","5232081485850214399","5232081503030083583","5232081520209952767","5232081537389821951","5232081554569691135","5232081571749560319","5232081588929429503","5232081606109298687","5232081623289167871","5232081640469037055","5232081657648906239","5232081674828775423","5232081692008644607","5232081709188513791","5232081726368382975","5232081743548252159","5232081760728121343","5232081777907990527","5232081795087859711","5232081812267728895","5232081829447598079","5232081846627467263","5232081863807336447","5232081880987205631","5232081898167074815","5232081915346943999","5232081932526813183","5232081949706682367","5232081966886551551","5232081984066420735","5232082001246289919","5232082018426159103","5232082035606028287","5232082052785897471","5232082069965766655","5232082087145635839","5232082104325505023","5232082121505374207","5232082138685243391","5232082155865112575","5232082173044981759","5232082190224850943","5232082207404720127","5232082224584589311","5232082241764458495","5232082258944327679","5232082276124196863","5232082293304066047","5232082310483935231","5232082327663804415","5232082344843673599","5232082362023542783","5232082379203411967","5232082396383281151","5232082413563150335","5232082430743019519","5232082447922888703","5232082465102757887","5232082482282627071","5232082499462496255","5232082516642365439","5232082533822234623","5232082551002103807","5232082568181972991","5232082585361842175","5232082602541711359","5232082619721580543","5232082636901449727","5232082654081318911","5232082671261188095","5232082688441057279","5232082705620926463","5232082722800795647","5232082739980664831","5232082757160534015","5232082774340403199","5232082791520272383","5232082808700141567","5232082825880010751","5232082843059879935","5232082860239749119","5232082877419618303","5232082894599487487","5232082911779356671","5232082928959225855","5232082946139095039","5232082963318964223","5232082980498833407","5232082997678702591","5232083014858571775","5232083032038440959","5232083049218310143","5232083066398179327","5232083083578048511","5232083100757917695","5232083117937786879","5232083135117656063","5232083152297525247","5232083169477394431","5232083186657263615","5232083203837132799","5232083221017001983","5232083238196871167","5232083255376740351","5232083272556609535","5232083289736478719","5232083306916347903","5232083324096217087","5232083341276086271","5232083358455955455","5232083375635824639","5232083392815693823","5232083409995563007","5232083427175432191","5232083444355301375","5232083461535170559","5232083478715039743","5232083495894908927","5232083513074778111","5232083530254647295","5232083547434516479","5232083564614385663","5232083581794254847","5232083598974124031","5232083616153993215","5232083633333862399","5232083650513731583","5232083667693600767","5232083684873469951","5232083702053339135","5232083719233208319","5232083736413077503","5232083753592946687","5232083770772815871","5232083787952685055","5232083805132554239","5232083822312423423","5232083839492292607","5232083856672161791","5232083873852030975","5232083891031900159","5232083908211769343","5232083925391638527","5232083942571507711","5232083959751376895","5232083976931246079","5232083994111115263","5232084011290984447","5232084028470853631","5232084045650722815","5232084062830591999","5232084080010461183","5232084097190330367","5232084114370199551","5232084131550068735","5232084148729937919","5232084165909807103","5232084183089676287","5232084200269545471","5232084217449414655","5232084234629283839","5232084251809153023","5232084268989022207","5232084286168891391","5232084303348760575","5232084320528629759","5232084337708498943","5232084354888368127","5232084372068237311","5232084389248106495","5232084406427975679","5232084423607844863","5232084440787714047","5232084457967583231","5232084475147452415","5232084492327321599","5232084509507190783","5232084526687059967","5232084543866929151","5232084561046798335","5232084578226667519","5232084595406536703","5232084612586405887","5232084629766275071","5232084646946144255","5232084664126013439","5232084681305882623","5232084698485751807","5232084715665620991","5232084732845490175","5232084750025359359","5232084767205228543","5232084784385097727","5232084801564966911","5232084818744836095","5232084835924705279","5232084853104574463","5232084870284443647","5232084887464312831","5232084904644182015","5232084921824051199","5232084939003920383","5232084956183789567","5232084973363658751","5232084990543527935","5232085007723397119","5232085024903266303","5232085042083135487","5232085059263004671","5232085076442873855","5232085093622743039","5232085110802612223","5232085127982481407","5232085145162350591","5232085162342219775","5232085179522088959","5232085196701958143","5232085213881827327","5232085231061696511","5232085248241565695","5232085265421434879","5232085282601304063","5232085299781173247","5232085316961042431","5232085334140911615","5232085351320780799","5232085368500649983","5232085385680519167","5232085402860388351","5232085420040257535","5232085437220126719","5232085454399995903","5232085471579865087","5232085488759734271","5232085505939603455","5232085523119472639","5232085540299341823","5232085557479211007","5232085574659080191","5232085591838949375","5232085609018818559","5232085626198687743","5232085643378556927","5232085660558426111","5232085677738295295","5232085694918164479","5232085712098033663","5232085729277902847","5232085746457772031","5232085763637641215","5232085780817510399","5232085797997379583","5232085815177248767","5232085832357117951","5232085849536987135","5232085866716856319","5232085883896725503","5232085901076594687","5232085918256463871","5232085935436333055","5232085952616202239","5232085969796071423","5232085986975940607","5232086004155809791","5232086021335678975","5232086038515548159","5232086055695417343","5232086072875286527","5232086090055155711","5232086107235024895","5232086124414894079","5232086141594763263","5232086158774632447","5232086175954501631","5232086193134370815","5232086210314239999","5232086227494109183","5232086244673978367","5232086261853847551","5232086279033716735","5232086296213585919","5232086313393455103","5232086330573324287","5232086347753193471","5232086364933062655","5232086382112931839","5232086399292801023","5232086416472670207","5232086433652539391","5232086450832408575","5232086468012277759","5232086485192146943","5232086502372016127","5232086519551885311","5232086536731754495","5232086553911623679","5232086571091492863","5232086588271362047","5232086605451231231","5232086622631100415","5232086639810969599","5232086656990838783","5232086674170707967","5232086691350577151","5232086708530446335","5232086725710315519","5232086742890184703","5232086760070053887","5232086777249923071","5232086794429792255","5232086811609661439","5232086828789530623","5232086845969399807","5232086863149268991","5232086880329138175","5232086897509007359","5232086914688876543","5232086931868745727","5232086949048614911","5232086966228484095","5232086983408353279","5232087000588222463","5232087017768091647","5232087034947960831","5232087052127830015","5232087069307699199","5232087086487568383","5232087103667437567","5232087120847306751","5232087138027175935","5232087155207045119","5232087172386914303","5232087189566783487","5232087206746652671","5232087223926521855","5232087241106391039","5232087258286260223","5232087275466129407","5232087292645998591","5232087309825867775","5232087327005736959","5232087344185606143","5232087361365475327","5232087378545344511","5232087395725213695","5232087412905082879","5232087430084952063","5232087447264821247","5232087464444690431","5232087481624559615","5232087498804428799","5232087515984297983","5232087533164167167","5232087550344036351","5232087567523905535","5232087584703774719","5232087601883643903","5232087619063513087","5232087636243382271","5232087653423251455","5232087670603120639","5232087687782989823","5232087704962859007","5232087722142728191","5232087739322597375","5232087756502466559","5232087773682335743","5232087790862204927","5232087808042074111","5232087825221943295","5232087842401812479","5232087859581681663","5232087876761550847","5232087893941420031","5232087911121289215","5232087928301158399","5232087945481027583","5232087962660896767","5232087979840765951","5232087997020635135","5232088014200504319","5232088031380373503","5232088048560242687","5232088065740111871","5232088082919981055","5232088100099850239","5232088117279719423","5232088134459588607","5232088151639457791","5232088168819326975","5232088185999196159","5232088203179065343","5232088220358934527","5232088237538803711","5232088254718672895","5232088271898542079","5232088289078411263","5232088306258280447","5232088323438149631","5232088340618018815","5232088357797887999","5232088374977757183","5232088392157626367","5232088409337495551","5232088426517364735","5232088443697233919","5232088460877103103","5232088478056972287","5232088495236841471","5232088512416710655","5232088529596579839","5232088546776449023","5232088563956318207","5232088581136187391","5232088598316056575","5232088615495925759","5232088632675794943","5232088649855664127","5232088667035533311","5232088684215402495","5232088701395271679","5232088718575140863","5232088735755010047","5232088752934879231","5232088770114748415","5232088787294617599","5232088804474486783","5232088821654355967","5232088838834225151","5232088856014094335","5232088873193963519","5232088890373832703","5232088907553701887","5232088924733571071","5232088941913440255","5232088959093309439","5232088976273178623","5232088993453047807","5232089010632916991","5232089027812786175","5232089044992655359","5232089062172524543","5232089079352393727","5232089096532262911","5232089113712132095","5232089130892001279","5232089148071870463","5232089165251739647","5232089182431608831","5232089199611478015","5232089216791347199","5232089233971216383","5232089251151085567","5232089268330954751","5232089285510823935","5232089302690693119","5232089319870562303","5232089337050431487","5232089354230300671","5232089371410169855","5232089388590039039","5232089405769908223","5232089422949777407","5232089440129646591","5232089457309515775","5232089474489384959","5232089491669254143","5232089508849123327","5232089526028992511","5232089543208861695","5232089560388730879","5232089577568600063","5232089594748469247","5232089611928338431","5232089629108207615","5232089646288076799","5232089663467945983","5232089680647815167","5232089697827684351","5232089715007553535","5232089732187422719","5232089749367291903","5232089766547161087","5232089783727030271","5232089800906899455","5232089818086768639","5232089835266637823","5232089852446507007","5232089869626376191","5232089886806245375","5232089903986114559","5232089921165983743","5232089938345852927","5232089955525722111","5232089972705591295","5232089989885460479","5232090007065329663","5232090024245198847","5232090041425068031","5232090058604937215","5232090075784806399","5232090092964675583","5232090110144544767","5232090127324413951","5232090144504283135","5232090161684152319","5232090178864021503","5232090196043890687","5232090213223759871","5232090230403629055","5232090247583498239","5232090264763367423","5232090281943236607","5232090299123105791","5232090316302974975","5232090333482844159","5232090350662713343","5232090367842582527","5232090385022451711","5232090402202320895","5232090419382190079","5232090436562059263","5232090453741928447","5232090470921797631","5232090488101666815","5232090505281535999","5232090522461405183","5232090539641274367","5232090556821143551","5232090574001012735","5232090591180881919","5232090608360751103","5232090625540620287","5232090642720489471","5232090659900358655","5232090677080227839","5232090694260097023","5232090711439966207","5232090728619835391","5232090745799704575","5232090762979573759","5232090780159442943","5232090797339312127","5232090814519181311","5232090831699050495","5232090848878919679","5232090866058788863","5232090883238658047","5232090900418527231","5232090917598396415","5232090934778265599","5232090951958134783","5232090969138003967","5232090986317873151","5232091003497742335","5232091020677611519","5232091037857480703","5232091055037349887","5232091072217219071","5232091089397088255","5232091106576957439","5232091123756826623","5232091140936695807","5232091158116564991","5232091175296434175","5232091192476303359","5232091209656172543","5232091226836041727","5232091244015910911","5232091261195780095","5232091278375649279","5232091295555518463","5232091312735387647","5232091329915256831","5232091347095126015","5232091364274995199","5232091381454864383","5232091398634733567","5232091415814602751","5232091432994471935","5232091450174341119","5232091467354210303","5232091484534079487","5232091501713948671","5232091518893817855","5232091536073687039","5232091553253556223","5232091570433425407","5232091587613294591","5232091604793163775","5232091621973032959","5232091639152902143","5232091656332771327","5232091673512640511","5232091690692509695","5232091707872378879","5232091725052248063","5232091742232117247","5232091759411986431","5232091776591855615","5232091793771724799","5232091810951593983","5232091828131463167","5232091845311332351","5232091862491201535","5232091879671070719","5232091896850939903","5232091914030809087","5232091931210678271","5232091948390547455","5232091965570416639","5232091982750285823","5232091999930155007","5232092017110024191","5232092034289893375","5232092051469762559"]');
});

test('QUADBIN_TOCHILDREN should throw an error for negative resolution', async () => {
    const query = 'SELECT `@@BQ_DATASET@@.QUADBIN_TOCHILDREN`(5209574053332910079, -1) AS output';
    await expect(runQuery(query)).rejects.toThrow();
});

test('QUADBIN_TOCHILDREN should throw an error for resolution overflow', async () => {
    const query = 'SELECT `@@BQ_DATASET@@.QUADBIN_TOCHILDREN`(5209574053332910079, 27) AS output';
    await expect(runQuery(query)).rejects.toThrow();
});

test('QUADBIN_TOCHILDREN should throw an error for resolution smaller than the index', async () => {
    const query = 'SELECT `@@BQ_DATASET@@.QUADBIN_TOCHILDREN`(5209574053332910079, 3) AS output';
    await expect(runQuery(query)).rejects.toThrow();
});