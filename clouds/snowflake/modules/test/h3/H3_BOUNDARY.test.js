const { runQuery } = require('../../../common/test-utils');

test('Returns NULL with invalid parameters', async () => {
    const query = `
        WITH ids AS
        (
            SELECT 1 AS id, NULL as hid UNION ALL
            SELECT 2 AS id, 'ff283473fffffff' as hid
        )
        SELECT
            id,
            H3_BOUNDARY(hid) as bounds
        FROM ids
        ORDER BY id ASC
    `;

    const rows = await runQuery(query);
    expect(rows.length).toEqual(2);
    expect(rows[0].BOUNDS).toEqual(null);
    expect(rows[1].BOUNDS).toEqual(null);
});

test('Returns the expected geography', async () => {
    const query = `
        WITH ids AS
        (
            SELECT 1 AS id, '85283473fffffff' as hid, TO_GEOGRAPHY('POLYGON((-121.91508032705622 37.271355866731895, -121.86222328902487 37.35392645085226, -121.92354999630157 37.42834118609435, -122.03773496427027 37.42012867767778, -122.09042892904397 37.33755608435298, -122.02910130918998 37.26319797461824, -121.91508032705622 37.2713558667318959))') AS expected UNION ALL
            SELECT 2 AS id, '81623ffffffffff' as hid, TO_GEOGRAPHY('POLYGON((55.94007484027041 12.754829243237465, 55.178175815407634 10.2969712998247, 55.25056228923789 9.092686031788569, 57.37516125699395 7.616228186063625, 58.549882762724735 7.302087248609305, 60.638711932789995 8.825639091130396, 61.315435771664646 9.83036925628956, 60.502253257733344 12.271971757766304, 59.732575088573185 13.216340916028171, 57.09422515125156 13.191260467897605, 55.94007484027041 12.754829243237465))') AS expected UNION ALL
            SELECT 3 AS id, '870813269ffffff' as hid, TO_GEOGRAPHY('POLYGON((14.711648031146114 63.277882025346415,14.712440922705934 63.26861190442848,14.73446836421859 63.26494482126122,14.755709705688332 63.27054633635922,14.755317756693326 63.27518180749664,14.752695851168275 63.28064279423593,14.732891492101386 63.28348535730845,14.711648031146114 63.277882025346415))') AS expected UNION ALL
            SELECT 4 AS id, '8708132c9ffffff' as hid, TO_GEOGRAPHY('POLYGON((14.980290407235753 63.17789340607063,14.981026086428166 63.16859620261361,15.002996154492914 63.164874810511954,15.024237224435646 63.17044909395252,15.0238738694539 63.175098100519314,15.021303345184416 63.18057404076462,15.001533688888642 63.183469499131554,14.980290407235753 63.17789340607063))') AS expected UNION ALL
            SELECT 5 AS id, '870811a69ffffff' as hid, TO_GEOGRAPHY('POLYGON((12.802705201609877 63.95493262768267,12.8039094653455 63.94585303660034,12.826318075218023 63.94256790087345,12.84752999039057 63.948360878458764,12.846932424218958 63.95290112494493,12.843943874747696 63.95825430649401,12.82391855217839 63.960727463737385,12.802705201609877 63.95493262768267))') AS expected
        )
        SELECT
            *,
            H3_BOUNDARY(hid) as bounds
        FROM ids
    `;

    const rows = await runQuery(query);
    expect(rows.length).toEqual(5);
    expect(rows[0].EXPECTED).toEqual(rows[0].BOUNDS);
    expect(rows[1].EXPECTED).toEqual(rows[1].BOUNDS);
    expect(rows[2].EXPECTED).toEqual(rows[2].BOUNDS);
    expect(rows[3].EXPECTED).toEqual(rows[3].BOUNDS);
    expect(rows[4].EXPECTED).toEqual(rows[4].BOUNDS);
});