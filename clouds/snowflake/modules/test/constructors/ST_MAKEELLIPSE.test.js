const { runQuery } = require('../../../common/test-utils');

test('ST_MAKEELLIPSE should work', async () => {
    const query = `
        SELECT ST_MAKEELLIPSE(ST_POINT(-73.9385,40.6643), 5, 3, -30, 'miles', 20) as ellipse1,
               ST_MAKEELLIPSE(ST_POINT(13.9385,0.6643), 10, 2, 15, 'kilometers', 10) as ellipse2,
               ST_MAKEELLIPSE(ST_POINT(53.9385,-10.6643), 8, 7, 100, 'miles', 15) as ellipse3
    `;
    const rows = await runQuery(query);
    expect(rows.length).toEqual(1);
    expect(JSON.stringify(rows[0].ELLIPSE1)).toEqual('{"coordinates":[[[-74.02107518664157,40.62808768352935],[-74.02578586912053,40.64495575036675],[-74.01928658020361,40.66217294938172],[-74.00552544077065,40.677942274256054],[-73.98741321359903,40.69132944557799],[-73.96713655442129,40.70189883216206],[-73.94492899560898,40.70993851807581],[-73.92057796990443,40.71515046932548],[-73.89567570510036,40.716314272627315],[-73.87274959323348,40.71198171470595],[-73.85583517062133,40.70045342872469],[-73.85116357059594,40.683578484761064],[-73.85770833503176,40.66637074387992],[-73.87150201164279,40.65061898606695],[-73.88962643061885,40.637249931282824],[-73.90989571700187,40.62669410130611],[-73.93207979676792,40.618661125845165],[-73.95639472208768,40.61344676394539],[-73.98125754246874,40.61226993099658],[-74.0041564265764,40.61658104353064],[-74.02107518664157,40.62808768352935]]],"type":"Polygon"}');
    expect(JSON.stringify(rows[0].ELLIPSE2)).toEqual('{"coordinates":[[[13.851626070520757,0.6875753513294511],[13.880362767288396,0.6930433027164747],[13.913554455332745,0.6885113177919474],[13.943155554175483,0.6816735330967083],[13.972209930923867,0.6727956838341635],[14.003220759618806,0.6601258167769598],[14.02537311107808,0.6410231216150398],[13.996636556376233,0.6355560133975638],[13.963445300223492,0.6400885562976],[13.933844478560538,0.6469264625177851],[13.90479018498845,0.6558040862365531],[13.87377913105105,0.6684733356678926],[13.851626070520757,0.6875753513294511]]],"type":"Polygon"}');
    expect(JSON.stringify(rows[0].ELLIPSE3)).toEqual('{"coordinates":[[[53.91803688489085,-10.778326228148556],[53.96701702637404,-10.773654819139944],[54.00625992002597,-10.748026503799485],[54.03078270631681,-10.711931865009936],[54.04145745683627,-10.671555947332156],[54.038529875163135,-10.629345771321681],[54.01964418094167,-10.58854619991272],[53.982717695860515,-10.557822804600134],[53.93399836162621,-10.54938828146205],[53.88860931879128,-10.565856439638315],[53.856668638982455,-10.597845633618306],[53.83923141259913,-10.636516850059445],[53.83521147600925,-10.678034498409696],[53.84569060731951,-10.720186959560534],[53.87364152301882,-10.757461202884317],[53.91803688489085,-10.778326228148556]]],"type":"Polygon"}');
});

test('ST_MAKEELLIPSE should return NULL if any NULL mandatory argument', async () => {
    const query = `
        SELECT ST_MAKEELLIPSE(NULL, 5, 3, -30, 'miles', 80) as ellipse1,
               ST_MAKEELLIPSE(ST_POINT(-73.9385,40.6643), NULL, 3, -30, 'miles', 80) as ellipse2,
               ST_MAKEELLIPSE(ST_POINT(-73.9385,40.6643), 5, NULL, -30, 'miles', 80) as ellipse3,
               ST_MAKEELLIPSE(ST_POINT(-73.9385,40.6643), 5, 3, NULL, 'miles', 80) as ellipse4,
               ST_MAKEELLIPSE(ST_POINT(-73.9385,40.6643), 5, 3, -30, NULL, 80) as ellipse5,
               ST_MAKEELLIPSE(ST_POINT(-73.9385,40.6643), 5, 3, -30, 'miles', NULL) as ellipse6
    `;
    const rows = await runQuery(query);
    expect(rows.length).toEqual(1);
    expect(rows[0].ELLIPSE1).toEqual(null);
    expect(rows[0].ELLIPSE2).toEqual(null);
    expect(rows[0].ELLIPSE3).toEqual(null);
    expect(rows[0].ELLIPSE4).toEqual(null);
    expect(rows[0].ELLIPSE5).toEqual(null);
    expect(rows[0].ELLIPSE6).toEqual(null);
});

test('ST_MAKEELLIPSE default values should work', async () => {
    const query = `
        SELECT ST_MAKEELLIPSE(ST_POINT(-73.9385,40.6643), 5, 3, 0, 'kilometers', 64) as defaultValue,
               ST_MAKEELLIPSE(ST_POINT(-73.9385,40.6643), 5, 3) as nullParam1,
               ST_MAKEELLIPSE(ST_POINT(-73.9385,40.6643), 5, 3, 0) as nullParam2,
               ST_MAKEELLIPSE(ST_POINT(-73.9385,40.6643), 5, 3, 0, 'kilometers') as nullParam3
    `;
    const rows = await runQuery(query);
    expect(rows.length).toEqual(1);
    expect(rows[0].NULLPARAM1).toEqual(rows[0].DEFAULTVALUE);
    expect(rows[0].NULLPARAM2).toEqual(rows[0].DEFAULTVALUE);
    expect(rows[0].NULLPARAM3).toEqual(rows[0].DEFAULTVALUE);
});